# 中西醫併用風險提示（Patient-reported TCM + FHIR MedicationDispense）規劃架構書

> 目標：讓病人以「清單點選」方式回報常見高風險中藥材/方劑；系統自動從 FHIR 取得西藥（優先 MedicationDispense），依規則表比對並產出風險分級提示與轉介建議。
> 定位：用藥安全風險提示與照護協作（非診斷/非治療建議）。

---

## 1. 範圍與非範圍

### 1.1 本期要做（MVP）

- 病人端：中藥材/方劑清單勾選回報（含別名搜尋）
- 後端（n8n 為核心）：寫入 patient-reported 用藥、拉取西藥、規則比對、產出結果
- 風險輸出：風險分級（低/中/高）+ 建議諮詢（醫師/藥師）
- 稽核與追蹤：保留每次比對結果與規則版本（可回溯）

### 1.2 本期不做（避免高風險/不可驗測）

- AI 診斷/預測（例如「預測出血/低血糖」）
- 自動停藥/換藥建議（僅提示與建議諮詢）
- 跨院即時整合（以單一 FHIR server/沙盒資料為主）
- 自由輸入中藥材（MVP 以點選清單降低資料品質風險）

---

## 2. 角色與使用情境

### 2.1 主要角色

- 病人（Patient）：勾選目前使用的中藥材/方劑
- 家屬（選配）：協助填報
- 醫療端使用者（選配）：查看風險提示與病人自述用藥摘要
- 系統管理者：維護清單/規則表與版本

### 2.2 使用情境（User Story）

- 病人拿藥行抓藥自煎，於 App 勾選「當歸、丹參…」並填寫開始日期與頻率
- 系統抓取病人近期 MedicationDispense，判定正在使用抗凝血藥
- 系統回覆：中/高風險提示（可能增加出血風險）+ 建議諮詢藥師/醫師 + 警訊提醒
- 若病人更新「已停用該中藥」，系統重新比對並更新風險

---

## 3. 資料來源與 FHIR 資源設計

### 3.1 西藥來源（FHIR）

- 首選：`MedicationDispense`（實際發藥/配藥）
- 次選：`MedicationRequest`（醫師開立處方）
- 補充（可選）：`MedicationStatement`（若系統已有「目前用藥清單」整合）

### 3.2 病人回報中藥（FHIR 寫入）

- 主建議：`MedicationStatement`（標註 patient-reported）
  - 欄位要點：
    - `status`：active/completed
    - `medicationCodeableConcept.coding[]`：清單 code（或至少 display）
    - `informationSource` / `note`：標註「病人自述」、來源（藥行/自煎/科學中藥）
    - `effective[x]`：開始日期/期間（若可）
    - `dosage`：頻率/用法（若可）

> 目標：病人回報資料與西藥資料皆存在 FHIR，便於稽核、交換、與後續擴充。

### 3.3 風險輸出（FHIR 寫回：視伺服器支援度）

- 優先顯示於 App/UI（MVP）
- 可選寫回 FHIR（擇一）：
  - `DetectedIssue`（較貼近「交互作用檢出」）
  - `Flag`（提醒標記）
  - `Communication` / `DocumentReference`（產出摘要文件/訊息）

---

## 4. 功能模組與待辦清單（To-Do）

### 4.1 清單與規則資料（核心資產）

- [ ] 建立「高風險中藥材/方劑清單」V1（20–50 項）
  - [ ] 欄位：canonical code、中文名、別名、分類（活血/補氣/利水…）、備註
- [ ] 建立「西藥風險分群表」V1（5–8 群）
  - [ ] 抗凝血/抗血小板、降血糖、降血壓、鎮靜安眠、利尿/電解質、免疫抑制/抗癌（可先保守）
- [ ] 建立「交互作用規則表」V1（10–30 條）
  - [ ] 欄位：TCM item → Rx group → 風險類型 → 嚴重度 → 建議文案 → 參考來源 → 版本號
- [ ] 規則版本管理（Rule versioning）
  - [ ] 每次比對結果需記錄使用的規則版本

### 4.2 病人端輸入（UI/表單）

- [ ] 清單瀏覽 + 搜尋（含別名）
- [ ] 勾選後補充欄位（最少集）
  - [ ] 是否「目前正在使用」
  - [ ] 開始日期（必填建議）
  - [ ] 頻率（每日/每週/不定期）
  - [ ] 來源（藥行抓藥/自煎/科學中藥/其他）
- [ ] 送出後顯示「風險摘要」與「注意事項」

### 4.3 n8n 工作流（核心自動化）

- [ ] Workflow A：接收病人回報（Webhook/API）
  - [ ] 驗證輸入（必填欄位、清單代碼合法性）
  - [ ] 轉換成 FHIR `MedicationStatement` JSON
  - [ ] 寫入 FHIR：POST/PUT MedicationStatement
- [ ] Workflow B：取得西藥清單（FHIR Query）
  - [ ] 查詢 MedicationDispense（依 patient + 期間）
  - [ ] 若無/不足：fallback MedicationRequest
  - [ ] 將西藥條目做去重與有效期間推估
- [ ] Workflow C：正規化與分群（Normalization）
  - [ ] 藥品代碼/名稱解析（院內碼/健保碼/ATC/文字）
  - [ ] 映射至風險分群（Rx group）
- [ ] Workflow D：規則比對與結果產出
  - [ ] 以「正在使用的中藥」×「有效期內西藥群組」比對規則表
  - [ ] 產出風險項目清單（含嚴重度、原因、建議）
  - [ ] 產出整體風險等級（低/中/高）與摘要
- [ ] Workflow E：結果回傳與（選配）寫回 FHIR
  - [ ] 回傳給 UI
  - [ ] 可選：寫回 DetectedIssue/Flag/Communication
- [ ] Workflow F：通知策略（避免通知疲乏）
  - [ ] 僅「中/高」風險才推播
  - [ ] 推播內容不包含診斷/處置指示，僅提示與諮詢建議

### 4.4 稽核、紀錄、與可追溯性

- [ ] 建立比對結果存放（DB/Redis/持久層）
  - [ ] patient id（去識別化 key）、時間戳、輸入中藥清單、取得西藥摘要、命中規則、規則版本
- [ ] Idempotency / 去重
  - [ ] 同一筆回報重送不重複寫入/通知
- [ ] 操作日誌（API 呼叫、FHIR 寫入失敗、重試）

---

## 5. 風險分級與文案原則（避免 SaMD 誤解）

### 5.1 分級建議

- 低：可能性低/證據弱 → 以衛教提醒為主
- 中：有合理機轉/常見併用風險 → 建議諮詢藥師/醫師
- 高：已知高風險組合（例如出血/低血糖顯著風險）→ 建議儘速諮詢 + 列出警訊

### 5.2 文案規範（必做）

- [ ] 明確標示「此為風險提示，非醫療診斷或治療建議」
- [ ] 不出現「請停藥/換藥/自行調整」措辭
- [ ] 提供「警訊症狀」與「就醫建議」模板（例如黑便、異常瘀青、頭暈冒冷汗等）
- [ ] 對 patient-reported 資料標示「以病人回報為準，可能不完整」

---

## 6. 驗測與測試計畫

### 6.1 測試資料案例集（必做）

- [ ] Case 1：活血類中藥 + 抗凝血/抗血小板（預期中/高風險）
- [ ] Case 2：降血糖藥 + 可能增強降血糖之草本（預期中風險）
- [ ] Case 3：無風險組合（預期低風險/無提示）
- [ ] Case 4：病人停用中藥後重新比對（風險下降/消失）
- [ ] Case 5：FHIR 無 MedicationDispense 時 fallback MedicationRequest

### 6.2 驗測項目

- [ ] FHIR 資源讀寫正確（schema、必填欄位、狀態碼）
- [ ] 規則命中正確、可重現
- [ ] 版本可回溯（同一輸入在同一規則版本下結果一致）
- [ ] 通知策略符合規範（不過度推播）

---

## 7. 安全、隱私與權限

- [ ] SMART scopes 設計（read/write 最小權限）
- [ ] Patient-reported 資料標示與可撤回（病人可刪除/停用）
- [ ] 個資最小化：比對結果可用去識別化 key 存放
- [ ] 存取稽核（必要時使用 AuditEvent/應用端 log）
- [ ] 內容安全：推播不含敏感細節，避免外洩

---

## 8. 交付物（Deliverables）

- [ ] 中藥材/方劑清單 V1（含別名與分類）
- [ ] 西藥分群表 V1（映射規則/對照表）
- [ ] 交互作用規則表 V1（含嚴重度與文案）
- [ ] n8n workflows（JSON）
  - [ ] 回報寫入（MedicationStatement）
  - [ ] 拉取與比對（Dispense/Request + rules）
  - [ ] 通知與記錄
- [ ] 測試案例集與驗測報告（可重現步驟）
- [ ] 操作與維護手冊（規則更新流程、版本管理）

---

## 9. 里程碑建議（可依徵案時程調整）

- M1：資料資產 V1（清單/分群/規則）完成
- M2：FHIR 讀取（Dispense/Request）與正規化完成
- M3：病人回報寫入（MedicationStatement）完成
- M4：比對引擎 + 風險輸出（UI）完成
- M5：測試案例集跑通 + 文件化 + 可驗測交付

---

## 10. 開放問題（需提早確認）

- [ ] 目標 FHIR server 版本（R4/R5）與支援資源清單（/metadata）
- [ ] 是否允許病人端寫入 MedicationStatement（scopes 與政策）
- [ ] 西藥代碼型態（院內碼/健保碼/ATC/文字）以決定正規化策略
- [ ] 是否需要寫回 DetectedIssue/Flag（伺服器支援度與院方接受度）
